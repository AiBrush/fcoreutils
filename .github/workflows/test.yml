name: Test

on:
  pull_request:
  merge_group:
  workflow_dispatch:

# Cancel in-progress runs for the same branch/PR
concurrency:
  group: test-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  RUSTFLAGS: ""

jobs:
  # Lint runs once on ubuntu — platform-independent checks
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          key: lint-v1
      - name: Install nasm and libssl-dev
        run: sudo apt-get install -y --no-install-recommends nasm libssl-dev
      - name: Clippy
        run: cargo clippy -- -D warnings
      - name: Check formatting
        run: cargo fmt -- --check

  # ── Linux: build once, test each command in parallel ──────────────
  build-linux:
    name: Build (ubuntu-latest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-ubuntu-latest
      - name: Install nasm and libssl-dev
        run: sudo apt-get install -y --no-install-recommends nasm libssl-dev
      - name: Build and compile tests
        run: cargo test --no-run

  # Module tests: src/{cmd}/tests.rs → cargo test "{cmd}::"
  test-linux-mod:
    name: Test ubuntu/${{ matrix.cmd }}
    needs: build-linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cmd: [base64, cat, chgrp, chmod, chown, comm, cp, csplit, cut, date, dd, df, du, echo, expand, expr, factor, fmt, fold, hash, head, install, join, ls, mv, nl, numfmt, od, paste, pinky, pr, printf, ptx, rev, rm, shred, sort, split, stat, stdbuf, stty, tac, tail, test_cmd, tr, uniq, users, wc, who]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-ubuntu-latest
          save-if: false
      - name: Install nasm and libssl-dev
        run: sudo apt-get install -y --no-install-recommends nasm libssl-dev
      - name: Run tests
        run: cargo test "${{ matrix.cmd }}::"

  # Binary tests: src/bin/f{cmd}.rs → cargo test --bin f{cmd}
  test-linux-bin:
    name: Test ubuntu/${{ matrix.cmd }}
    needs: build-linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        cmd: [arch, base32, basename, basenc, chcon, chroot, cksum, dircolors, dirname, env, false, groups, hostid, id, kill, link, ln, logname, mkdir, mkfifo, mknod, mktemp, nice, nohup, nproc, pathchk, printenv, pwd, readlink, realpath, rmdir, runcon, seq, shuf, sleep, sum, sync, tee, timeout, touch, true, truncate, tsort, tty, uname, unlink, uptime, whoami, yes]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-ubuntu-latest
          save-if: false
      - name: Install nasm and libssl-dev
        run: sudo apt-get install -y --no-install-recommends nasm libssl-dev
      - name: Run tests
        run: cargo test --bin "f${{ matrix.cmd }}"

  # ── macOS: build once, test each command in parallel ──────────────
  build-macos:
    name: Build (macos-latest)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-macos-latest
      - name: Build and compile tests
        run: cargo test --no-run

  test-macos-mod:
    name: Test macos/${{ matrix.cmd }}
    needs: build-macos
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        cmd: [base64, cat, chgrp, chmod, chown, comm, cp, csplit, cut, date, dd, df, du, echo, expand, expr, factor, fmt, fold, hash, head, install, join, ls, mv, nl, numfmt, od, paste, pinky, pr, printf, ptx, rev, rm, shred, sort, split, stat, stdbuf, stty, tac, tail, test_cmd, tr, uniq, users, wc, who]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-macos-latest
          save-if: false
      - name: Run tests
        run: cargo test "${{ matrix.cmd }}::"

  test-macos-bin:
    name: Test macos/${{ matrix.cmd }}
    needs: build-macos
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        cmd: [arch, base32, basename, basenc, chcon, chroot, cksum, dircolors, dirname, env, false, groups, hostid, id, kill, link, ln, logname, mkdir, mkfifo, mknod, mktemp, nice, nohup, nproc, pathchk, printenv, pwd, readlink, realpath, rmdir, runcon, seq, shuf, sleep, sum, sync, tee, timeout, touch, true, truncate, tsort, tty, uname, unlink, uptime, whoami, yes]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-macos-latest
          save-if: false
      - name: Run tests
        run: cargo test --bin "f${{ matrix.cmd }}"

  # ── Windows: build once, test each command in parallel ────────────
  build-windows:
    name: Build (windows-latest)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-windows-latest
      - name: Build and compile tests
        run: cargo test --no-run

  test-windows-mod:
    name: Test windows/${{ matrix.cmd }}
    needs: build-windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        cmd: [base64, cat, chgrp, chmod, chown, comm, cp, csplit, cut, date, dd, df, du, echo, expand, expr, factor, fmt, fold, hash, head, install, join, ls, mv, nl, numfmt, od, paste, pinky, pr, printf, ptx, rev, rm, shred, sort, split, stat, stdbuf, stty, tac, tail, test_cmd, tr, uniq, users, wc, who]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-windows-latest
          save-if: false
      - name: Run tests
        run: cargo test "${{ matrix.cmd }}::"

  test-windows-bin:
    name: Test windows/${{ matrix.cmd }}
    needs: build-windows
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        cmd: [arch, base32, basename, basenc, chcon, chroot, cksum, dircolors, dirname, env, false, groups, hostid, id, kill, link, ln, logname, mkdir, mkfifo, mknod, mktemp, nice, nohup, nproc, pathchk, printenv, pwd, readlink, realpath, rmdir, runcon, seq, shuf, sleep, sum, sync, tee, timeout, touch, true, truncate, tsort, tty, uname, unlink, uptime, whoami, yes]
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-v2-windows-latest
          save-if: false
      - name: Run tests
        run: cargo test --bin "f${{ matrix.cmd }}"

  # ── Gate: all platform tests must pass (use as required check) ────
  test-passed:
    name: Tests passed
    if: always()
    needs: [test-linux-mod, test-linux-bin, test-macos-mod, test-macos-bin, test-windows-mod, test-windows-bin]
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          results=("${{ needs.test-linux-mod.result }}" "${{ needs.test-linux-bin.result }}" \
                   "${{ needs.test-macos-mod.result }}" "${{ needs.test-macos-bin.result }}" \
                   "${{ needs.test-windows-mod.result }}" "${{ needs.test-windows-bin.result }}")
          for r in "${results[@]}"; do
            if [[ "$r" != "success" ]]; then
              echo "Some tests failed: $r"
              exit 1
            fi
          done
          echo "All 98 command tests passed on all platforms"

  # ── Assembly: build all 20 tools once, upload as artifact ─────────
  assembly-build:
    name: Build assembly
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install nasm
        run: sudo apt-get install -y --no-install-recommends nasm
      - name: Build all assembly tools
        run: |
          set -e
          # fyes (Python build script)
          cd assembly/yes && python3 build.py --no-verify && cd ../..
          # NASM unified tools (flat binary)
          for tool in true logname hostid tty whoami pwd sync sleep echo; do
            nasm -f bin assembly/$tool/f${tool}_unified.asm -o assembly/$tool/f$tool
            chmod +x assembly/$tool/f$tool
          done
          # NASM unified tools (unified/ subdirectory)
          for tool in head tail tac rev cut tr base64 md5sum; do
            nasm -f bin assembly/$tool/unified/f${tool}_unified.asm -o assembly/$tool/f$tool
            chmod +x assembly/$tool/f$tool
          done
          # wc (modular ELF build)
          mkdir -p assembly/wc/build/lib assembly/wc/build/tools
          nasm -f elf64 -I assembly/wc/ assembly/wc/lib/io.asm -o assembly/wc/build/lib/io.o
          nasm -f elf64 -I assembly/wc/ assembly/wc/lib/str.asm -o assembly/wc/build/lib/str.o
          nasm -f elf64 -I assembly/wc/ assembly/wc/tools/fwc.asm -o assembly/wc/build/tools/fwc.o
          ld --gc-sections -n -s assembly/wc/build/tools/fwc.o assembly/wc/build/lib/io.o assembly/wc/build/lib/str.o -o assembly/wc/fwc
          chmod +x assembly/wc/fwc
          # arch (GAS syntax)
          as --64 assembly/arch/farch_unified.s -o /tmp/farch.o
          ld -o assembly/arch/farch /tmp/farch.o
          chmod +x assembly/arch/farch
          rm -f /tmp/farch.o
          echo "All 20 assembly tools built successfully"
      - uses: actions/upload-artifact@v6
        with:
          name: assembly-binaries
          path: |
            assembly/yes/fyes
            assembly/true/ftrue
            assembly/arch/farch
            assembly/logname/flogname
            assembly/hostid/fhostid
            assembly/tty/ftty
            assembly/whoami/fwhoami
            assembly/pwd/fpwd
            assembly/sync/fsync
            assembly/sleep/fsleep
            assembly/echo/fecho
            assembly/head/fhead
            assembly/tail/ftail
            assembly/tac/ftac
            assembly/rev/frev
            assembly/wc/fwc
            assembly/cut/fcut
            assembly/tr/ftr
            assembly/base64/fbase64
            assembly/md5sum/fmd5sum

  # ── Assembly: test each tool in parallel (20 x86 + 1 ARM64) ──────
  assembly-test:
    name: Test asm/${{ matrix.tool }}
    needs: assembly-build
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        tool: [yes, true, arch, logname, hostid, tty, whoami, pwd, sync, sleep, echo, head, tail, tac, rev, wc, cut, tr, base64, md5sum]
        runner: [ubuntu-latest]
        include:
          - tool: yes-arm64
            runner: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v6
      - uses: actions/download-artifact@v6
        if: matrix.tool != 'yes-arm64'
        with:
          name: assembly-binaries
          path: assembly
      - name: Setup
        if: matrix.tool != 'yes-arm64'
        run: |
          chmod +x assembly/${{ matrix.tool }}/f${{ matrix.tool }}
          sudo apt-get install -y --no-install-recommends strace
      - name: Functional tests
        if: matrix.tool != 'yes-arm64'
        run: |
          if [ "${{ matrix.tool }}" = "yes" ]; then
            cd assembly/yes
            python3 ../../tests/assembly/fyes_vs_yes_tests.py --test-only
          else
            bash assembly/${{ matrix.tool }}/tests/run_tests.sh ./assembly/${{ matrix.tool }}/f${{ matrix.tool }}
          fi
      - name: Security tests
        if: matrix.tool != 'yes' && matrix.tool != 'yes-arm64'
        run: python3 assembly/${{ matrix.tool }}/tests/security_tests.py
      - name: Build ARM64 fyes
        if: matrix.tool == 'yes-arm64'
        run: |
          as -o /tmp/fyes_arm64.o assembly/yes/fyes_arm64.s
          ld -static -s -e _start -o /tmp/fyes_arm64 /tmp/fyes_arm64.o
          chmod +x /tmp/fyes_arm64
      - name: Test ARM64 fyes
        if: matrix.tool == 'yes-arm64'
        run: |
          /tmp/fyes_arm64 | head -5
          /tmp/fyes_arm64 hello | head -3
          /tmp/fyes_arm64 --help
          /tmp/fyes_arm64 --version
          echo "All ARM64 assembly fyes smoke tests passed."
