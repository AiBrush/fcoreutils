name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

# Serialize releases so two quick merges get sequential versions
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  # ── Derive next version from latest git tag ──────────────────────
  calculate-version:
    name: Calculate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.version }}
      tag: ${{ steps.calc.outputs.tag }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Calculate next version
        id: calc
        run: |
          latest=$(git tag -l 'v*' --sort=-v:refname | head -1)
          if [[ -z "$latest" ]]; then
            latest="v0.0.0"
          fi
          echo "Latest tag: $latest"

          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"

          bump="${{ inputs.bump_type || 'patch' }}"
          echo "Bump type: $bump"

          case "$bump" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac

          new_version="${major}.${minor}.${patch}"
          new_tag="v${new_version}"
          echo "New version: $new_version (tag: $new_tag)"

          if git rev-parse "$new_tag" >/dev/null 2>&1; then
            echo "::error::Tag $new_tag already exists!"
            exit 1
          fi

          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "tag=$new_tag" >> "$GITHUB_OUTPUT"

  # ── Build release binaries for all platforms ─────────────────────
  build:
    name: Build (${{ matrix.target }})
    needs: [calculate-version]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            cross: true
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Set version
        shell: bash
        run: |
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          else
            sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          fi

      - name: Install cross
        if: matrix.cross
        run: cargo install cross

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: Create release archive
        shell: bash
        run: |
          mkdir -p release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            for bin in fwc fcut fbase64 fsha256sum fsort ftr funiq fb2sum ftac fmd5sum; do
              cp "target/${{ matrix.target }}/release/${bin}.exe" release/ 2>/dev/null || true
            done
            7z a coreutils-rs-${{ matrix.target }}.zip release/*
          else
            for bin in fwc fcut fbase64 fsha256sum fsort ftr funiq fb2sum ftac fmd5sum; do
              cp "target/${{ matrix.target }}/release/${bin}" release/ 2>/dev/null || true
            done
            tar -czf coreutils-rs-${{ matrix.target }}.tar.gz -C release .
          fi

      - name: Upload archive
        uses: actions/upload-artifact@v6
        with:
          name: release-${{ matrix.target }}
          path: coreutils-rs-*

  # ── Publish: tag, crates.io, GitHub Release ──────────────────────
  publish:
    name: Publish
    needs: [calculate-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
          pattern: release-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Create and push tag
        run: |
          git tag "${{ needs.calculate-version.outputs.tag }}"
          git push origin "${{ needs.calculate-version.outputs.tag }}"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        if: "${{ secrets.CARGO_REGISTRY_TOKEN != '' }}"
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          cargo publish --allow-dirty --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"
        continue-on-error: true

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/*'

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.calculate-version.outputs.tag }}" dist/* \
            --title "${{ needs.calculate-version.outputs.tag }}" \
            --generate-notes
