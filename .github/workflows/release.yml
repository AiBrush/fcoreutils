name: Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  calculate-version:
    name: Calculate version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.calc.outputs.version }}
      tag: ${{ steps.calc.outputs.tag }}
      publish_crates: ${{ steps.calc.outputs.publish_crates }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Calculate next version
        id: calc
        run: |
          latest=$(git tag -l 'v*' --sort=-v:refname | head -1)
          if [[ -z "$latest" ]]; then
            latest="v0.0.0"
          fi
          echo "Latest tag: $latest"

          version="${latest#v}"
          IFS='.' read -r major minor patch <<< "$version"

          bump="${{ inputs.bump_type || 'patch' }}"
          echo "Bump type: $bump"

          case "$bump" in
            major) major=$((major + 1)); minor=0; patch=0 ;;
            minor) minor=$((minor + 1)); patch=0 ;;
            patch) patch=$((patch + 1)) ;;
          esac

          # Auto-promote: every 10 patches, bump to minor release instead.
          # Minor releases also publish to crates.io. Patch releases are
          # GitHub-only to stay within crates.io daily rate limits.
          publish_crates="false"
          if [[ "$bump" == "patch" && $((patch % 10)) -eq 0 && $patch -gt 0 ]]; then
            echo "Auto-promoting patch $patch to minor release (every 10 patches)"
            minor=$((minor + 1))
            patch=0
            publish_crates="true"
          fi
          # Manual minor/major bumps also publish to crates.io
          if [[ "$bump" == "minor" || "$bump" == "major" ]]; then
            publish_crates="true"
          fi

          new_version="${major}.${minor}.${patch}"
          new_tag="v${new_version}"
          echo "New version: $new_version (tag: $new_tag)"
          echo "Publish to crates.io: $publish_crates"

          if git rev-parse "$new_tag" >/dev/null 2>&1; then
            echo "::error::Tag $new_tag already exists!"
            exit 1
          fi

          echo "version=$new_version" >> "$GITHUB_OUTPUT"
          echo "tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "publish_crates=$publish_crates" >> "$GITHUB_OUTPUT"

  build:
    name: Build (${{ matrix.name }})
    needs: [calculate-version]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: Linux x86_64
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            name: Linux ARM64
          - os: macos-latest
            target: x86_64-apple-darwin
            name: macOS x86_64
            cross: true
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macOS ARM64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: Windows x86_64

    steps:
      - uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.cross && matrix.target || '' }}

      - name: Set version
        shell: bash
        run: |
          if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          else
            sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          fi

      - name: Set RUSTFLAGS for target CPU
        shell: bash
        run: |
          case "${{ matrix.target }}" in
            x86_64-*)
              echo "RUSTFLAGS=-C target-cpu=x86-64-v3" >> "$GITHUB_ENV"
              ;;
            aarch64-*)
              echo "RUSTFLAGS=-C target-cpu=generic" >> "$GITHUB_ENV"
              ;;
            *)
              echo "RUSTFLAGS=" >> "$GITHUB_ENV"
              ;;
          esac

      - name: Install nasm and libssl-dev (Linux, macOS x86_64)
        if: matrix.target == 'x86_64-unknown-linux-gnu' || matrix.target == 'aarch64-unknown-linux-gnu' || matrix.target == 'x86_64-apple-darwin'
        shell: bash
        run: |
          if [[ "$OSTYPE" == "linux"* ]]; then
            if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-gnu" ]]; then
              sudo apt-get install -y --no-install-recommends nasm libssl-dev
            else
              sudo apt-get install -y --no-install-recommends libssl-dev
            fi
          else
            brew install nasm || true
          fi

      - name: Build
        shell: bash
        run: |
          if [[ "$OSTYPE" == "linux"* ]]; then
            OPENSSL_STATIC=1 cargo build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Create release archive
        shell: bash
        run: |
          mkdir -p release
          BINDIR="target/${{ matrix.target }}/release"
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            # Copy ALL f* binaries (not just a hardcoded subset)
            for bin in "${BINDIR}"/f*.exe; do
              [ -f "$bin" ] && cp "$bin" release/
            done
            7z a fcoreutils-${{ matrix.target }}.zip release/*
          else
            # Copy ALL f* binaries (not just a hardcoded subset)
            for bin in "${BINDIR}"/f*; do
              [ -f "$bin" ] && [ -x "$bin" ] && [[ "$(basename "$bin")" != *.* ]] && cp "$bin" release/
            done
            # On Linux x86_64: replace the Rust fyes with the NASM flat-binary assembly.
            if [[ "${{ matrix.target }}" == "x86_64-unknown-linux-gnu" ]]; then
              cd assembly/yes
              python3 build.py --target linux-x86_64 -o ../../release/fyes \
                && echo "Assembly fyes (linux-x86_64) built and placed in release/" \
                || echo "Assembly build failed — shipping Rust fyes instead"
              cd ../..
            fi
            # On Linux ARM64: use build.py for patched + assembled ARM64 binary.
            if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
              cd assembly/yes
              python3 build.py --target linux-arm64 -o ../../release/fyes \
                && echo "Assembly fyes (linux-arm64) built and placed in release/" \
                || echo "Assembly build failed — shipping Rust fyes instead"
              cd ../..
            fi
            # On macOS x86_64: build Mach-O assembly binary.
            if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" ]]; then
              cd assembly/yes
              python3 build.py --target macos-x86_64 -o ../../release/fyes \
                && echo "Assembly fyes (macos-x86_64) built and placed in release/" \
                || echo "Assembly build failed — shipping Rust fyes instead"
              cd ../..
            fi
            # On macOS ARM64: build Mach-O ARM64 assembly binary.
            if [[ "${{ matrix.target }}" == "aarch64-apple-darwin" ]]; then
              cd assembly/yes
              python3 build.py --target macos-arm64 -o ../../release/fyes \
                && echo "Assembly fyes (macos-arm64) built and placed in release/" \
                || echo "Assembly build failed — shipping Rust fyes instead"
              cd ../..
            fi
            tar -czf fcoreutils-${{ matrix.target }}.tar.gz -C release .
          fi
          echo "Packaged $(ls release/ | wc -l) binaries:"
          ls release/ | head -20
          echo "..."

      - name: Upload archive
        uses: actions/upload-artifact@v6
        with:
          name: release-${{ matrix.target }}
          path: fcoreutils-*

  publish:
    name: Publish
    needs: [calculate-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Create and push tag
        run: |
          git tag "${{ needs.calculate-version.outputs.tag }}"
          git push origin "${{ needs.calculate-version.outputs.tag }}"

      - uses: dtolnay/rust-toolchain@stable
        if: needs.calculate-version.outputs.publish_crates == 'true'

      - name: Publish to crates.io
        if: needs.calculate-version.outputs.publish_crates == 'true'
        continue-on-error: true
        run: |
          sed -i 's/^version = ".*"/version = "${{ needs.calculate-version.outputs.version }}"/' Cargo.toml
          cargo publish --allow-dirty --token "${{ secrets.CARGO_REGISTRY_TOKEN }}"

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist
          pattern: release-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/*'

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.calculate-version.outputs.tag }}" dist/* \
            --title "${{ needs.calculate-version.outputs.tag }}" \
            --generate-notes